#!/usr/bin/env sh
# Script to process data and output temperature contour (and other stuff that I don't use).
# The temperature contour is output in a different format to the original code's implementation (t,x,y,T).

codeDir=$(cd "$(dirname "$0")" && pwd)

echo "codeDir: $codeDir"

input="$1"
inputAbs=$(realpath "$input") # Get absolute path of input directory
bn=$(basename "$input")

cd "$(dirname "$inputAbs")" || exit 1

mv "$bn" results/
mkdir "$bn"
mv results "$bn/"

cd "$bn/results" || exit 1
ls > ../event_names.dat

for f in */; do
    cd "$f" || continue
    mkdir -p results
    mv *.dat results/
    cp "$codeDir/hydro_analysis.e" .
    cp "$codeDir/parameters.dat" .
    ./hydro_analysis.e
    rm hydro_analysis.e
    # Delete files listed in files_to_delete parameter
    files_to_delete=$(grep '^files_to_delete' parameters.dat | cut -d'=' -f2 | cut -d'#' -f1 | tr -d ' ')
    if [ -n "$files_to_delete" ]; then
        IFS=',' read -ra files <<< "$files_to_delete"
        for del_file in "${files[@]}"; do
            [ -n "$del_file" ] && rm -f "$del_file"
        done
    fi
    cd ..
done